<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´¢åŠ¡ä¿éšœ - æ‚¨çš„ä¸ªäººè´¢åŠ¡ç®¡å®¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #f8faf9 0%, #e8f5e8 100%);
        }
        .hero-title {
            font-family: 'Noto Serif SC', serif;
        }
        .card-shadow {
            box-shadow: 0 4px 20px rgba(45, 90, 39, 0.1);
        }
        .gradient-text {
            background: linear-gradient(135deg, #2D5A27, #4A90A4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .floating-animation {
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        .pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite alternate;
        }
        @keyframes pulse-glow {
            from { box-shadow: 0 0 20px rgba(212, 175, 55, 0.3); }
            to { box-shadow: 0 0 30px rgba(212, 175, 55, 0.6); }
        }
        .toast-notification {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .touch-feedback {
            transition: transform 0.1s ease;
        }
        .touch-feedback:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body class="min-h-screen pb-20">
    <!-- Hero Section -->
    <div class="relative overflow-hidden bg-gradient-to-br from-green-50 to-blue-50 px-4 pt-8 pb-6">
        <div class="absolute top-0 right-0 w-32 h-32 opacity-10">
            <div class="w-full h-full bg-gradient-to-br from-green-400 to-blue-500 rounded-full floating-animation flex items-center justify-center">
                <span class="text-4xl">ğŸ’°</span>
            </div>
        </div>
        
        <div class="relative z-10">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h1 class="hero-title text-2xl font-bold gradient-text">è´¢åŠ¡ä¿éšœ</h1>
                    <p class="text-sm text-gray-600 mt-1">æ‚¨çš„ä¸ªäººè´¢åŠ¡ç®¡å®¶</p>
                </div>
                <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-blue-500 rounded-full flex items-center justify-center">
                    <span class="text-white text-lg">ğŸ’</span>
                </div>
            </div>
            
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl p-4 card-shadow">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-sm text-gray-600">æœ¬æœˆè´¢åŠ¡çŠ¶å†µ</span>
                    <span class="text-xs bg-green-100 text-green-600 px-2 py-1 rounded-full" id="financialStatus">å¥åº·ç¨³å¥</span>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-xs text-gray-500">æ€»æ”¶å…¥</p>
                        <p class="text-lg font-bold text-green-600" id="totalIncome">Â¥0</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500">æ€»æ”¯å‡º</p>
                        <p class="text-lg font-bold text-red-500" id="totalExpense">Â¥0</p>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-t border-gray-100">
                    <p class="text-xs text-gray-500">ç»“ä½™</p>
                    <p class="text-xl font-bold text-blue-600" id="balance">Â¥0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="px-4 mb-6">
        <div class="grid grid-cols-2 gap-3">
            <button onclick="showAddBillModal()" class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-xl card-shadow pulse-glow touch-feedback">
                <div class="text-2xl mb-2">ğŸ“</div>
                <div class="text-sm font-medium">è®°å½•è´¦å•</div>
            </button>
            <button onclick="window.location.href='savings.html'" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-xl card-shadow touch-feedback">
                <div class="text-2xl mb-2">ğŸ¯</div>
                <div class="text-sm font-medium">å‚¨è“„ç›®æ ‡</div>
            </button>
        </div>
    </div>

    <!-- Financial Health Score -->
    <div class="px-4 mb-6">
        <div class="bg-white rounded-2xl p-4 card-shadow">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-gray-800">è´¢åŠ¡å¥åº·åº¦</h3>
                <button onclick="window.location.href='analysis.html'" class="text-xs text-blue-500">æŸ¥çœ‹è¯¦æƒ…</button>
            </div>
            <div class="flex items-center justify-center mb-4">
                <div class="relative w-24 h-24">
                    <svg class="w-24 h-24 transform -rotate-90" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                        <circle cx="50" cy="50" r="40" stroke="#4ade80" stroke-width="8" fill="none" 
                                stroke-dasharray="251.2" stroke-dashoffset="62.8" stroke-linecap="round" id="healthScoreCircle"/>
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span class="text-lg font-bold text-green-600" id="healthScore">75</span>
                    </div>
                </div>
            </div>
            <div class="text-center">
                <p class="text-sm text-gray-600" id="profileType">å¥åº·ç¨³å¥å‹</p>
                <p class="text-xs text-gray-500 mt-1">æ‚¨çš„è´¢åŠ¡çŠ¶å†µè‰¯å¥½ï¼Œç»§ç»­ä¿æŒï¼</p>
            </div>
        </div>
    </div>

    <!-- Recent Bills -->
    <div class="px-4 mb-6">
        <div class="bg-white rounded-2xl p-4 card-shadow">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-gray-800">æœ€è¿‘è´¦å•</h3>
                <button onclick="window.location.href='bills.html'" class="text-xs text-blue-500">æŸ¥çœ‹å…¨éƒ¨</button>
            </div>
            <div id="recentBills" class="space-y-3">
                <div class="flex items-center justify-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Savings Goals Preview -->
    <div class="px-4 mb-6">
        <div class="bg-white rounded-2xl p-4 card-shadow">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-gray-800">å‚¨è“„ç›®æ ‡</h3>
                <button onclick="window.location.href='savings.html'" class="text-xs text-blue-500">ç®¡ç†ç›®æ ‡</button>
            </div>
            <div id="savingsGoals" class="space-y-3">
                <div class="flex items-center justify-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Financial Tips -->
    <div class="px-4 mb-6">
        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-2xl p-4 card-shadow border border-yellow-200">
            <div class="flex items-start space-x-3">
                <div class="w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center flex-shrink-0">
                    <span class="text-white text-sm">ğŸ’¡</span>
                </div>
                <div>
                    <h4 class="font-medium text-gray-800 mb-1">è´¢åŠ¡å°è´´å£«</h4>
                    <p class="text-sm text-gray-600" id="financialTip">å»ºè®®å°†æ”¶å…¥çš„20%ç”¨äºå‚¨è“„å’ŒæŠ•èµ„ï¼Œå»ºç«‹åº”æ€¥åŸºé‡‘ï¼Œä¸ºæœªæ¥åšå¥½å‡†å¤‡ã€‚</p>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Advice Section -->
    <div class="px-4 mb-6">
        <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl p-4 card-shadow border border-purple-200">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-gray-800">ğŸ’¡ AIç†è´¢å»ºè®®</h3>
                <button onclick="getAIAdvice()" class="text-xs bg-purple-500 text-white px-3 py-1 rounded-full" id="aiAdviceBtn">è·å–å»ºè®®</button>
            </div>
            <div id="aiAdviceContent" class="text-sm text-gray-600">
                ç‚¹å‡»è·å–æŒ‰é’®ï¼Œè®©AIä¸ºæ‚¨æä¾›ä¸ªæ€§åŒ–çš„ç†è´¢å»ºè®®ã€‚
            </div>
        </div>
    </div>

    <!-- Add Bill Modal -->
    <div id="addBillModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-end justify-center min-h-screen">
            <div class="bg-white rounded-t-3xl w-full max-w-md p-6 transform transition-transform duration-300 translate-y-full modal-content" id="modalContent">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">æ·»åŠ è´¦å•</h3>
                    <button onclick="hideAddBillModal()" class="text-gray-400 text-xl touch-feedback">Ã—</button>
                </div>
                
                <form id="billForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ç±»å‹</label>
                        <select id="billType" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <option value="income">æ”¶å…¥</option>
                            <option value="expense">æ”¯å‡º</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">é‡‘é¢</label>
                        <input type="number" id="billAmount" placeholder="0.00" step="0.01" 
                               class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">åˆ†ç±»</label>
                        <select id="billCategory" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ—¥æœŸ</label>
                        <input type="date" id="billDate" 
                               class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å¤‡æ³¨</label>
                        <input type="text" id="billNote" placeholder="æ·»åŠ å¤‡æ³¨..." 
                               class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                    
                    <button type="submit" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white p-3 rounded-xl font-medium touch-feedback">
                        æ·»åŠ è´¦å•
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-40">
        <div class="grid grid-cols-5 h-16">
            <a href="index.html" class="flex flex-col items-center justify-center text-green-600">
                <span class="text-lg mb-1">ğŸ </span>
                <span class="text-xs">é¦–é¡µ</span>
            </a>
            <a href="bills.html" class="flex flex-col items-center justify-center text-gray-400">
                <span class="text-lg mb-1">ğŸ“</span>
                <span class="text-xs">è´¦å•</span>
            </a>
            <a href="analysis.html" class="flex flex-col items-center justify-center text-gray-400">
                <span class="text-lg mb-1">ğŸ“Š</span>
                <span class="text-xs">åˆ†æ</span>
            </a>
            <a href="savings.html" class="flex flex-col items-center justify-center text-gray-400">
                <span class="text-lg mb-1">ğŸ¯</span>
                <span class="text-xs">å‚¨è“„</span>
            </a>
            <a href="insurance.html" class="flex flex-col items-center justify-center text-gray-400">
                <span class="text-lg mb-1">ğŸ›¡ï¸</span>
                <span class="text-xs">ä¿éšœ</span>
            </a>
        </div>
    </nav>

    <script src="main.js"></script>
    <script>
        // é¦–é¡µç‰¹å®šçš„JavaScript
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            loadRecentBills();
            loadSavingsGoals();
            
            // è®¾ç½®ä»Šå¤©çš„æ—¥æœŸ
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('billDate').value = today;
            
            // åˆå§‹åŒ–åˆ†ç±»é€‰é¡¹
            updateCategoryOptions('expense');
        });

        // åŠ è½½ä»ªè¡¨ç›˜æ•°æ®
        async function loadDashboardData() {
            try {
                const data = await financeManager.getDashboardSummary();
                
                financeManager.animateNumber('totalIncome', data.totalIncome);
                financeManager.animateNumber('totalExpense', data.totalExpense);
                financeManager.animateNumber('balance', data.balance);
                
                // æ›´æ–°è´¢åŠ¡å¥åº·åº¦
                const healthScore = data.healthScore || 75;
                document.getElementById('healthScore').textContent = healthScore;
                
                // æ›´æ–°åœ†å½¢è¿›åº¦æ¡
                const circle = document.getElementById('healthScoreCircle');
                const circumference = 2 * Math.PI * 40;
                const offset = circumference - (healthScore / 100) * circumference;
                circle.style.strokeDashoffset = offset;
                
                // æ›´æ–°è´¢åŠ¡çŠ¶æ€
                if (healthScore >= 80) {
                    document.getElementById('financialStatus').textContent = 'ä¼˜ç§€';
                    document.getElementById('financialStatus').className = 'text-xs bg-green-100 text-green-600 px-2 py-1 rounded-full';
                } else if (healthScore >= 60) {
                    document.getElementById('financialStatus').textContent = 'è‰¯å¥½';
                    document.getElementById('financialStatus').className = 'text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full';
                } else {
                    document.getElementById('financialStatus').textContent = 'éœ€æ”¹å–„';
                    document.getElementById('financialStatus').className = 'text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full';
                }
                
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
                showToast('åŠ è½½æ•°æ®å¤±è´¥', 'error');
            }
        }

        // åŠ è½½æœ€è¿‘è´¦å•
        async function loadRecentBills() {
            try {
                const bills = await financeManager.getBills({ limit: 5 });
                const container = document.getElementById('recentBills');
                
                if (bills.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-4 text-gray-500">
                            <div class="text-4xl mb-2">ğŸ“</div>
                            <p class="text-sm">è¿˜æ²¡æœ‰è´¦å•è®°å½•</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = bills.map(bill => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center ${
                                bill.type === 'income' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'
                            }">
                                ${bill.type === 'income' ? 'ğŸ“ˆ' : 'ğŸ“‰'}
                            </div>
                            <div>
                                <p class="font-medium text-gray-800 text-sm">${financeManager.getCategoryName(bill.category)}</p>
                                <p class="text-xs text-gray-500">${bill.date}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold ${bill.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                                ${bill.type === 'income' ? '+' : '-'}Â¥${parseFloat(bill.amount).toFixed(2)}
                            </p>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Failed to load recent bills:', error);
                document.getElementById('recentBills').innerHTML = `
                    <div class="text-center py-4 text-red-500">
                        <p class="text-sm">åŠ è½½è´¦å•å¤±è´¥</p>
                    </div>
                `;
            }
        }

        // åŠ è½½å‚¨è“„ç›®æ ‡
        async function loadSavingsGoals() {
            try {
                const goals = await financeManager.getSavingsGoals({ limit: 3 });
                const container = document.getElementById('savingsGoals');
                
                if (goals.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-4 text-gray-500">
                            <div class="text-4xl mb-2">ğŸ¯</div>
                            <p class="text-sm">è¿˜æ²¡æœ‰å‚¨è“„ç›®æ ‡</p>
                            <button onclick="window.location.href='savings.html'" class="text-blue-500 text-xs mt-2">åˆ›å»ºç›®æ ‡</button>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = goals.map(goal => `
                    <div class="p-3 bg-gray-50 rounded-xl">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-medium text-gray-800 text-sm">${goal.name}</h4>
                            <span class="text-xs text-gray-500">${getSavingsGoalTypeName(goal.type)}</span>
                        </div>
                        <div class="mb-2">
                            <div class="flex justify-between text-xs text-gray-600 mb-1">
                                <span>Â¥${goal.currentAmount.toFixed(2)}</span>
                                <span>Â¥${goal.targetAmount.toFixed(2)}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-green-500 h-2 rounded-full" style="width: ${Math.min(goal.progress, 100)}%"></div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500">
                            å·²å®Œæˆ ${goal.progress.toFixed(1)}%
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Failed to load savings goals:', error);
                document.getElementById('savingsGoals').innerHTML = `
                    <div class="text-center py-4 text-red-500">
                        <p class="text-sm">åŠ è½½å‚¨è“„ç›®æ ‡å¤±è´¥</p>
                    </div>
                `;
            }
        }

        // è·å–AIå»ºè®®
        async function getAIAdvice() {
            const btn = document.getElementById('aiAdviceBtn');
            const content = document.getElementById('aiAdviceContent');
            
            btn.textContent = 'è·å–ä¸­...';
            btn.disabled = true;
            content.innerHTML = '<div class="flex items-center justify-center py-4"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-purple-500"></div></div>';
            
            try {
                let adviceText = '';
                await financeManager.getFinancialAdviceStream((chunk) => {
                    adviceText += chunk;
                    content.innerHTML = adviceText;
                });
                
                btn.textContent = 'é‡æ–°è·å–';
                btn.disabled = false;
            } catch (error) {
                console.error('Failed to get AI advice:', error);
                content.innerHTML = 'è·å–å»ºè®®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚';
                btn.textContent = 'è·å–å»ºè®®';
                btn.disabled = false;
            }
        }

        // æ¨¡æ€æ¡†æ§åˆ¶
        function showAddBillModal() {
            document.getElementById('addBillModal').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('modalContent').classList.remove('translate-y-full');
            }, 10);
        }

        function hideAddBillModal() {
            const modal = document.getElementById('addBillModal');
            const content = document.getElementById('modalContent');
            content.classList.add('translate-y-full');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // è¡¨å•æäº¤å¤„ç†
        document.getElementById('billForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const bill = {
                type: document.getElementById('billType').value,
                amount: parseFloat(document.getElementById('billAmount').value),
                category: document.getElementById('billCategory').value,
                date: document.getElementById('billDate').value,
                note: document.getElementById('billNote').value
            };

            if (!bill.amount || !bill.date) {
                showToast('é‡‘é¢å’Œæ—¥æœŸä¸èƒ½ä¸ºç©º', 'error');
                return;
            }

            try {
                await financeManager.addBill(bill);
                showToast('è´¦å•æ·»åŠ æˆåŠŸï¼', 'success');
                hideAddBillModal();
                
                // åˆ·æ–°æ•°æ®
                loadDashboardData();
                loadRecentBills();
                
                // é‡ç½®è¡¨å•
                document.getElementById('billForm').reset();
                document.getElementById('billDate').value = new Date().toISOString().split('T')[0];
                updateCategoryOptions('expense');
                
            } catch (error) {
                showToast('æ·»åŠ å¤±è´¥: ' + error.message, 'error');
            }
        });
    </script>
</body>
</html>