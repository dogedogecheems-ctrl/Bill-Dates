<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´¢åŠ¡ä¿éšœ - è´¢åŠ¡ä¿éšœ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #f8faf9 0%, #e8f5e8 100%);
        }
        .card-shadow {
            box-shadow: 0 4px 20px rgba(45, 90, 39, 0.1);
        }
        .toast-notification {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .touch-feedback {
            transition: transform 0.1s ease;
        }
        .touch-feedback:active {
            transform: scale(0.98);
        }
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
        .product-card {
            transition: all 0.3s ease;
        }
        .product-card:active {
            transform: scale(0.98);
        }
        .risk-low { border-left: 4px solid #10B981; }
        .risk-medium { border-left: 4px solid #F59E0B; }
        .risk-high { border-left: 4px solid #EF4444; }
    </style>
</head>
<body class="min-h-screen pb-20">
    <!-- Header -->
    <div class="bg-white shadow-sm px-4 py-4">
        <div class="flex items-center justify-between">
            <h1 class="text-xl font-bold text-gray-800">è´¢åŠ¡ä¿éšœ</h1>
            <div class="flex items-center space-x-2">
                <button onclick="showRiskAssessment()" class="p-2 text-gray-600 touch-feedback">
                    <span class="text-lg">ğŸ“‹</span>
                </button>
                <button onclick="refreshProducts()" class="p-2 text-gray-600 touch-feedback">
                    <span class="text-lg">ğŸ”„</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Risk Profile Summary -->
    <div class="px-4 py-4">
        <div class="bg-white rounded-2xl p-4 card-shadow">
            <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold text-gray-800">é£é™©ç”»åƒ</h3>
                <button onclick="showRiskAssessment()" class="text-xs text-blue-500">é‡æ–°è¯„ä¼°</button>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex-1">
                    <div class="flex items-center mb-2">
                        <div class="w-4 h-4 rounded-full mr-2" id="riskLevelColor" style="background-color: #10B981;"></div>
                        <span class="font-medium" id="riskLevelText">å¹³è¡¡å‹</span>
                    </div>
                    <p class="text-xs text-gray-600" id="riskLevelDescription">é€‚åˆä¸­ç­‰é£é™©çš„æŠ•èµ„äº§å“</p>
                </div>
                <div class="text-right">
                    <p class="text-xs text-gray-500">é£é™©è¯„åˆ†</p>
                    <p class="text-lg font-bold" id="riskScore">75</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Categories -->
    <div class="px-4 mb-4">
        <div class="flex space-x-2 overflow-x-auto pb-2">
            <button onclick="filterProducts('all')" class="category-tab flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition-all bg-green-500 text-white" data-category="all">
                å…¨éƒ¨
            </button>
            <button onclick="filterProducts('fund')" class="category-tab flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition-all bg-gray-200 text-gray-700" data-category="fund">
                åŸºé‡‘
            </button>
            <button onclick="filterProducts('insurance')" class="category-tab flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition-all bg-gray-200 text-gray-700" data-category="insurance">
                ä¿é™©
            </button>
            <button onclick="filterProducts('deposit')" class="category-tab flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition-all bg-gray-200 text-gray-700" data-category="deposit">
                å­˜æ¬¾
            </button>
            <button onclick="filterProducts('bond')" class="category-tab flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition-all bg-gray-200 text-gray-700" data-category="bond">
                å€ºåˆ¸
            </button>
            <button onclick="filterProducts('stock')" class="category-tab flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition-all bg-gray-200 text-gray-700" data-category="stock">
                è‚¡ç¥¨
            </button>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="px-4 mb-4">
        <div class="relative">
            <input type="text" id="productSearch" placeholder="æœç´¢ç†è´¢äº§å“..." 
                   class="w-full p-3 pl-10 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent">
            <div class="absolute left-3 top-1/2 transform -translate-y-1/2">
                <span class="text-gray-400">ğŸ”</span>
            </div>
        </div>
    </div>

    <!-- Products List -->
    <div class="px-4">
        <div id="productsList" class="space-y-4">
            <div class="flex items-center justify-center py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
            </div>
        </div>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="hidden px-4 py-12">
        <div class="text-center">
            <div class="text-6xl mb-4">ğŸ’°</div>
            <h3 class="text-lg font-semibold text-gray-800 mb-2">æš‚æ— ç†è´¢äº§å“</h3>
            <p class="text-sm text-gray-500 mb-6">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åå†è¯•</p>
            <button onclick="refreshProducts()" class="bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-xl font-medium touch-feedback">
                é‡æ–°åŠ è½½
            </button>
        </div>
    </div>

    <!-- Product Detail Modal -->
    <div id="productDetailModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-end justify-center min-h-screen">
            <div class="bg-white rounded-t-3xl w-full max-w-md p-6 transform transition-transform duration-300 translate-y-full modal-content" id="detailModalContent">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold" id="productDetailTitle">äº§å“è¯¦æƒ…</h3>
                    <button onclick="hideProductDetailModal()" class="text-gray-400 text-xl touch-feedback">Ã—</button>
                </div>
                
                <div id="productDetailContent">
                    <!-- Product details will be loaded here -->
                </div>
                
                <div class="mt-6">
                    <button onclick="hideProductDetailModal()" class="w-full bg-gray-200 text-gray-700 p-3 rounded-xl font-medium touch-feedback">
                        å…³é—­
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Risk Assessment Modal -->
    <div id="riskAssessmentModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-end justify-center min-h-screen">
            <div class="bg-white rounded-t-3xl w-full max-w-md p-6 transform transition-transform duration-300 translate-y-full modal-content" id="assessmentModalContent">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">é£é™©è¯„ä¼°é—®å·</h3>
                    <button onclick="hideRiskAssessmentModal()" class="text-gray-400 text-xl touch-feedback">Ã—</button>
                </div>
                
                <div id="questionnaireContent">
                    <!-- Questionnaire will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-40">
        <div class="grid grid-cols-5 h-16">
            <a href="index.html" class="flex flex-col items-center justify-center text-gray-400">
                <span class="text-lg mb-1">ğŸ </span>
                <span class="text-xs">é¦–é¡µ</span>
            </a>
            <a href="bills.html" class="flex flex-col items-center justify-center text-gray-400">
                <span class="text-lg mb-1">ğŸ“</span>
                <span class="text-xs">è´¦å•</span>
            </a>
            <a href="analysis.html" class="flex flex-col items-center justify-center text-gray-400">
                <span class="text-lg mb-1">ğŸ“Š</span>
                <span class="text-xs">åˆ†æ</span>
            </a>
            <a href="savings.html" class="flex flex-col items-center justify-center text-gray-400">
                <span class="text-lg mb-1">ğŸ¯</span>
                <span class="text-xs">å‚¨è“„</span>
            </a>
            <a href="insurance.html" class="flex flex-col items-center justify-center text-green-600">
                <span class="text-lg mb-1">ğŸ›¡ï¸</span>
                <span class="text-xs">ä¿éšœ</span>
            </a>
        </div>
    </nav>

    <script src="main.js"></script>
    <script>
        // ä¿éšœé¡µé¢ç‰¹å®šçš„JavaScript
        let currentCategory = 'all';
        let currentPage = 1;
        let isLoading = false;
        let riskProfile = null;
        let questionnaires = [];
        let currentQuestionnaire = null;
        let currentQuestionIndex = 0;
        let questionnaireAnswers = {};

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadRiskProfile();
            loadFinancialProducts();
            loadQuestionnaires();
            setupSearch();
        });

        // åŠ è½½é£é™©ç”»åƒ
        async function loadRiskProfile() {
            try {
                riskProfile = await financeManager.getRiskProfile();
                updateRiskProfileDisplay();
            } catch (error) {
                console.error('Failed to load risk profile:', error);
                // ä½¿ç”¨é»˜è®¤é£é™©ç”»åƒ
                riskProfile = {
                    score: 75,
                    riskLevel: 'balanced',
                    answers: {}
                };
                updateRiskProfileDisplay();
            }
        }

        // æ›´æ–°é£é™©ç”»åƒæ˜¾ç¤º
        function updateRiskProfileDisplay() {
            if (!riskProfile) return;
            
            const riskLevels = {
                'conservative': { name: 'ä¿å®ˆå‹', color: '#10B981', description: 'é€‚åˆä½é£é™©çš„ç†è´¢äº§å“' },
                'balanced': { name: 'å¹³è¡¡å‹', color: '#F59E0B', description: 'é€‚åˆä¸­ç­‰é£é™©çš„æŠ•èµ„äº§å“' },
                'aggressive': { name: 'ç§¯æå‹', color: '#EF4444', description: 'é€‚åˆé«˜é£é™©çš„æŠ•èµ„äº§å“' }
            };
            
            const level = riskLevels[riskProfile.riskLevel] || riskLevels['balanced'];
            
            document.getElementById('riskLevelColor').style.backgroundColor = level.color;
            document.getElementById('riskLevelText').textContent = level.name;
            document.getElementById('riskLevelDescription').textContent = level.description;
            document.getElementById('riskScore').textContent = riskProfile.score || 75;
        }

        // åŠ è½½ç†è´¢äº§å“
        async function loadFinancialProducts() {
            const productsList = document.getElementById('productsList');
            const emptyState = document.getElementById('emptyState');
            
            if (currentPage === 1) {
                productsList.innerHTML = `
                    <div class="flex items-center justify-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                    </div>
                `;
            }
            
            try {
                let products = [];
                
                if (currentCategory === 'all') {
                    products = await financeManager.getFinancialProducts();
                } else {
                    products = await financeManager.searchFinancialProducts('', currentCategory);
                }
                
                if (products.length === 0 && currentPage === 1) {
                    productsList.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    return;
                }
                
                emptyState.classList.add('hidden');
                
                if (currentPage === 1) {
                    productsList.innerHTML = '';
                }
                
                const productHTML = products.map(product => createProductHTML(product)).join('');
                
                if (currentPage === 1) {
                    productsList.innerHTML = productHTML;
                } else {
                    productsList.insertAdjacentHTML('beforeend', productHTML);
                }
                
                // æ·»åŠ è¿›å…¥åŠ¨ç”»
                anime({
                    targets: '.product-card',
                    translateY: [20, 0],
                    opacity: [0, 1],
                    delay: anime.stagger(100),
                    duration: 500,
                    easing: 'easeOutQuart'
                });
                
            } catch (error) {
                console.error('Failed to load financial products:', error);
                if (currentPage === 1) {
                    productsList.innerHTML = `<div class="text-center text-red-500 py-4">åŠ è½½äº§å“å¤±è´¥</div>`;
                }
            } finally {
                isLoading = false;
            }
        }

        // åˆ›å»ºäº§å“HTML
        function createProductHTML(product) {
            const riskClass = `risk-${product.riskLevel}`;
            const riskColor = financeManager.getRiskLevelColor(product.riskLevel);
            const typeIcon = financeManager.getProductTypeIcon(product.productType);
            
            return `
                <div class="product-card bg-white rounded-2xl p-4 card-shadow ${riskClass}" onclick="showProductDetail(${product.id})">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-gradient-to-br from-green-100 to-blue-100 rounded-full flex items-center justify-center text-2xl">
                                ${typeIcon}
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-800 text-sm">${product.name}</h3>
                                <p class="text-xs text-gray-500">${APP_CONFIG.productTypes[product.productType]?.name || product.productType}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="flex items-center space-x-1 mb-1">
                                <div class="w-3 h-3 rounded-full" style="background-color: ${riskColor}"></div>
                                <span class="text-xs text-gray-600">${APP_CONFIG.riskLevels[product.riskLevel]?.name || product.riskLevel}</span>
                            </div>
                            <span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded-full">
                                ${product.expectedReturn ? product.expectedReturn + '%' : 'ä¿æœ¬'}
                            </span>
                        </div>
                    </div>
                    
                    <p class="text-xs text-gray-600 mb-3 line-clamp-2">${product.description}</p>
                    
                    <div class="flex items-center justify-between text-xs text-gray-500">
                        <span>èµ·æŠ•ï¼šÂ¥${product.minInvestment || 0}</span>
                        <span>${product.investmentPeriod || 'é•¿æœŸ'}</span>
                    </div>
                    
                    ${product.tags && product.tags.length > 0 ? `
                        <div class="flex flex-wrap gap-1 mt-2">
                            ${product.tags.slice(0, 3).map(tag => `
                                <span class="text-xs px-2 py-1 bg-blue-50 text-blue-600 rounded-full">${tag}</span>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // ç­›é€‰äº§å“
        function filterProducts(category) {
            currentCategory = category;
            currentPage = 1;
            
            // æ›´æ–°åˆ†ç±»æ ‡ç­¾æ ·å¼
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('bg-green-500', 'text-white');
                tab.classList.add('bg-gray-200', 'text-gray-700');
            });
            document.querySelector(`[data-category="${category}"]`).classList.add('bg-green-500', 'text-white');
            document.querySelector(`[data-category="${category}"]`).classList.remove('bg-gray-200', 'text-gray-700');
            
            loadFinancialProducts();
        }

        // æœç´¢è®¾ç½®
        function setupSearch() {
            const searchInput = document.getElementById('productSearch');
            let searchTimeout;
            
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const query = this.value.trim();
                    if (query) {
                        searchProducts(query);
                    } else {
                        loadFinancialProducts();
                    }
                }, 300);
            });
        }

        // æœç´¢äº§å“
        async function searchProducts(query) {
            const productsList = document.getElementById('productsList');
            
            productsList.innerHTML = `
                <div class="flex items-center justify-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                </div>
            `;
            
            try {
                const products = await financeManager.searchFinancialProducts(query);
                
                if (products.length === 0) {
                    productsList.innerHTML = `
                        <div class="text-center py-12 text-gray-500">
                            <div class="text-4xl mb-2">ğŸ”</div>
                            <p class="text-sm">æœªæ‰¾åˆ°ç›¸å…³äº§å“</p>
                        </div>
                    `;
                    return;
                }
                
                productsList.innerHTML = products.map(product => createProductHTML(product)).join('');
                
                // æ·»åŠ è¿›å…¥åŠ¨ç”»
                anime({
                    targets: '.product-card',
                    translateY: [20, 0],
                    opacity: [0, 1],
                    delay: anime.stagger(50),
                    duration: 500,
                    easing: 'easeOutQuart'
                });
                
            } catch (error) {
                console.error('Failed to search products:', error);
                productsList.innerHTML = `<div class="text-center text-red-500 py-4">æœç´¢å¤±è´¥</div>`;
            }
        }

        // æ˜¾ç¤ºäº§å“è¯¦æƒ…
        function showProductDetail(productId) {
            const product = financeManager.financialProducts.find(p => p.id === productId);
            if (!product) return;
            
            const modal = document.getElementById('productDetailModal');
            const content = document.getElementById('detailModalContent');
            const detailContent = document.getElementById('productDetailContent');
            
            const riskColor = financeManager.getRiskLevelColor(product.riskLevel);
            const typeIcon = financeManager.getProductTypeIcon(product.productType);
            
            detailContent.innerHTML = `
                <div class="space-y-4">
                    <div class="text-center mb-4">
                        <div class="w-16 h-16 mx-auto mb-3 bg-gradient-to-br from-green-100 to-blue-100 rounded-full flex items-center justify-center text-3xl">
                            ${typeIcon}
                        </div>
                        <h3 class="text-lg font-bold text-gray-800 mb-1">${product.name}</h3>
                        <div class="flex items-center justify-center space-x-2">
                            <div class="w-3 h-3 rounded-full" style="background-color: ${riskColor}"></div>
                            <span class="text-sm text-gray-600">${APP_CONFIG.riskLevels[product.riskLevel]?.name || product.riskLevel}</span>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between py-2 border-b border-gray-100">
                            <span class="text-gray-600">äº§å“ç±»å‹</span>
                            <span class="font-medium">${APP_CONFIG.productTypes[product.productType]?.name || product.productType}</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-gray-100">
                            <span class="text-gray-600">é¢„æœŸæ”¶ç›Š</span>
                            <span class="font-medium text-green-600">
                                ${product.expectedReturn ? product.expectedReturn + '%' : 'ä¿æœ¬'}
                            </span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-gray-100">
                            <span class="text-gray-600">èµ·æŠ•é‡‘é¢</span>
                            <span class="font-medium">Â¥${product.minInvestment || 0}</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-gray-100">
                            <span class="text-gray-600">æŠ•èµ„æœŸé™</span>
                            <span class="font-medium">${product.investmentPeriod || 'é•¿æœŸ'}</span>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-medium text-gray-800 mb-2">äº§å“æè¿°</h4>
                        <p class="text-sm text-gray-600 leading-relaxed">${product.description}</p>
                    </div>
                    
                    ${product.features && Object.keys(product.features).length > 0 ? `
                        <div>
                            <h4 class="font-medium text-gray-800 mb-2">äº§å“ç‰¹è‰²</h4>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                ${Object.entries(product.features).map(([key, value]) => `
                                    <div class="flex justify-between p-2 bg-gray-50 rounded">
                                        <span class="text-gray-600">${key}:</span>
                                        <span class="font-medium">${value}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${product.tags && product.tags.length > 0 ? `
                        <div>
                            <h4 class="font-medium text-gray-800 mb-2">äº§å“æ ‡ç­¾</h4>
                            <div class="flex flex-wrap gap-2">
                                ${product.tags.map(tag => `
                                    <span class="text-xs px-3 py-1 bg-blue-50 text-blue-600 rounded-full">${tag}</span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('translate-y-full');
            }, 10);
        }

        // éšè—äº§å“è¯¦æƒ…æ¨¡æ€æ¡†
        function hideProductDetailModal() {
            const modal = document.getElementById('productDetailModal');
            const content = document.getElementById('detailModalContent');
            
            content.classList.add('translate-y-full');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // åˆ·æ–°äº§å“åˆ—è¡¨
        function refreshProducts() {
            showToast('æ­£åœ¨åˆ·æ–°äº§å“åˆ—è¡¨...', 'info');
            currentPage = 1;
            loadFinancialProducts();
        }

        // åŠ è½½é—®å·
        async function loadQuestionnaires() {
            try {
                questionnaires = await financeManager.getQuestionnaires();
                if (questionnaires.length > 0) {
                    currentQuestionnaire = questionnaires.find(q => q.type === 'risk_assessment') || questionnaires[0];
                }
            } catch (error) {
                console.error('Failed to load questionnaires:', error);
            }
        }

        // æ˜¾ç¤ºé£é™©è¯„ä¼°
        function showRiskAssessment() {
            if (!currentQuestionnaire) {
                showToast('é—®å·åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                return;
            }
            
            currentQuestionIndex = 0;
            questionnaireAnswers = {};
            
            const modal = document.getElementById('riskAssessmentModal');
            const content = document.getElementById('assessmentModalContent');
            const questionnaireContent = document.getElementById('questionnaireContent');
            
            showQuestion(questionnaireContent);
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('translate-y-full');
            }, 10);
        }

        // æ˜¾ç¤ºé—®é¢˜
        function showQuestion(container) {
            const question = currentQuestionnaire.questions[currentQuestionIndex];
            if (!question) return;
            
            container.innerHTML = `
                <div class="space-y-4">
                    <div class="mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-gray-500">é—®é¢˜ ${currentQuestionIndex + 1} / ${currentQuestionnaire.questions.length}</span>
                            <div class="w-20 bg-gray-200 rounded-full h-2">
                                <div class="bg-green-500 h-2 rounded-full transition-all duration-300" 
                                     style="width: ${((currentQuestionIndex + 1) / currentQuestionnaire.questions.length) * 100}%"></div>
                            </div>
                        </div>
                        <h4 class="font-medium text-gray-800">${question.question}</h4>
                    </div>
                    
                    <div class="space-y-2">
                        ${question.options.map((option, index) => `
                            <label class="flex items-center p-3 border border-gray-200 rounded-xl cursor-pointer hover:bg-gray-50 transition-colors">
                                <input type="radio" name="question_${question.id}" value="${option.value}" class="mr-3">
                                <span class="text-sm text-gray-700">${option.text}</span>
                            </label>
                        `).join('')}
                    </div>
                    
                    <div class="flex space-x-3 pt-4">
                        ${currentQuestionIndex > 0 ? `
                            <button onclick="previousQuestion()" class="flex-1 bg-gray-200 text-gray-700 p-3 rounded-xl font-medium touch-feedback">
                                ä¸Šä¸€é¢˜
                            </button>
                        ` : ''}
                        <button onclick="nextQuestion()" class="flex-1 bg-gradient-to-r from-green-500 to-green-600 text-white p-3 rounded-xl font-medium touch-feedback" 
                                ${question.type === 'single_choice' ? 'disabled' : ''}>
                            ${currentQuestionIndex === currentQuestionnaire.questions.length - 1 ? 'å®Œæˆ' : 'ä¸‹ä¸€é¢˜'}
                        </button>
                    </div>
                </div>
            `;

            if (question.type === 'single_choice') {
                const radioButtons = container.querySelectorAll(`input[name="question_${question.id}"]`);
                const nextButton = container.querySelector('button[onclick="nextQuestion()"]');

                radioButtons.forEach(radio => {
                    radio.addEventListener('change', function() {
                        // åªè¦æœ‰ä»»ä½•ä¸€ä¸ªé€‰é¡¹è¢«é€‰ä¸­ï¼Œå°±ç§»é™¤ç¦ç”¨çŠ¶æ€
                        if (this.checked) {
                            nextButton.removeAttribute('disabled');
                        }
                    });

                    // æ£€æŸ¥æ˜¯å¦å·²ç»å›ç­”è¿‡ï¼Œå¦‚æœå›ç­”è¿‡åˆ™å¯ç”¨æŒ‰é’®
                    const previousAnswer = questionnaireAnswers[question.id];
                    if (previousAnswer && previousAnswer.value == radio.value) {
                        radio.checked = true; // ç¡®ä¿é€‰ä¸­çŠ¶æ€æ¢å¤
                        nextButton.removeAttribute('disabled');
                    }
                });
            }
        }

        // ä¸‹ä¸€é¢˜
        function nextQuestion() {
            const question = currentQuestionnaire.questions[currentQuestionIndex];
            const selectedOption = document.querySelector(`input[name="question_${question.id}"]:checked`);
            
            if (!selectedOption) {
                showToast('è¯·é€‰æ‹©ä¸€ä¸ªé€‰é¡¹', 'error');
                return;
            }
            
            questionnaireAnswers[question.id] = {
                value: selectedOption.value,
                text: question.options.find(opt => opt.value == selectedOption.value)?.text
            };
            
            if (currentQuestionIndex < currentQuestionnaire.questions.length - 1) {
                currentQuestionIndex++;
                const container = document.getElementById('questionnaireContent');
                showQuestion(container);
            } else {
                completeAssessment();
            }
        }

        // ä¸Šä¸€é¢˜
        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                const container = document.getElementById('questionnaireContent');
                showQuestion(container);
            }
        }

        // å®Œæˆè¯„ä¼°
        async function completeAssessment() {
            try {
                // è®¡ç®—é£é™©è¯„åˆ†
                let totalScore = 0;
                Object.values(questionnaireAnswers).forEach(answer => {
                    totalScore += parseInt(answer.value) || 0;
                });
                
                // ç¡®å®šé£é™©ç­‰çº§
                let riskLevel = 'balanced';
                if (totalScore <= 16) {
                    riskLevel = 'conservative';
                } else if (totalScore >= 25) {
                    riskLevel = 'aggressive';
                }
                
                // æ›´æ–°é£é™©ç”»åƒ
                const profileData = {
                    score: totalScore,
                    answers: questionnaireAnswers,
                    riskLevel: riskLevel
                };
                
                await financeManager.updateRiskProfile(profileData);
                riskProfile = profileData;
                updateRiskProfileDisplay();
                
                hideRiskAssessmentModal();
                showToast('é£é™©è¯„ä¼°å®Œæˆï¼', 'success');
                
                // é‡æ–°åŠ è½½æ¨èäº§å“
                loadFinancialProducts();
                
            } catch (error) {
                showToast('è¯„ä¼°å¤±è´¥: ' + error.message, 'error');
            }
        }

        // éšè—é£é™©è¯„ä¼°æ¨¡æ€æ¡†
        function hideRiskAssessmentModal() {
            const modal = document.getElementById('riskAssessmentModal');
            const content = document.getElementById('assessmentModalContent');
            
            content.classList.add('translate-y-full');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // éšè—é£é™©è¯„ä¼°æ¨¡æ€æ¡†
        function hideRiskAssessmentModal() {
            const modal = document.getElementById('riskAssessmentModal');
            const content = document.getElementById('assessmentModalContent');
            
            content.classList.add('translate-y-full');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }
    </script>
</body>
</html>