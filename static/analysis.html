<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´¢åŠ¡åˆ†æ - è´¢åŠ¡ä¿éšœ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #f8faf9 0%, #e8f5e8 100%);
        }
        .card-shadow {
            box-shadow: 0 4px 20px rgba(45, 90, 39, 0.1);
        }
        .toast-notification {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .touch-feedback {
            transition: transform 0.1s ease;
        }
        .touch-feedback:active {
            transform: scale(0.98);
        }
        .chart-container {
            height: 300px;
        }
        .tab-active {
            background: linear-gradient(135deg, #2D5A27, #4A90A4);
            color: white;
        }
    </style>
</head>
<body class="min-h-screen pb-20">
    <!-- Header -->
    <div class="bg-white shadow-sm px-4 py-4">
        <div class="flex items-center justify-between">
            <h1 class="text-xl font-bold text-gray-800">è´¢åŠ¡åˆ†æ</h1>
            <div class="flex items-center space-x-2">
                <button onclick="refreshAnalysis()" class="p-2 text-gray-600 touch-feedback">
                    <span class="text-lg">ğŸ”„</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Analysis Tabs -->
    <div class="px-4 py-4">
        <div class="flex space-x-2 bg-gray-100 rounded-xl p-1">
            <button onclick="switchTab('overview')" class="analysis-tab flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all tab-active" data-tab="overview">
                æ€»è§ˆ
            </button>
            <button onclick="switchTab('trends')" class="analysis-tab flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all text-gray-600" data-tab="trends">
                è¶‹åŠ¿
            </button>
            <button onclick="switchTab('expenses')" class="analysis-tab flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all text-gray-600" data-tab="expenses">
                æ”¯å‡º
            </button>
        </div>
    </div>

    <!-- Overview Tab -->
    <div id="overviewTab" class="tab-content px-4">
        <!-- Financial Health Score -->
        <div class="mb-6">
            <div class="bg-white rounded-2xl p-4 card-shadow">
                <h3 class="font-semibold text-gray-800 mb-4">è´¢åŠ¡å¥åº·åº¦</h3>
                <div class="flex items-center justify-center mb-4">
                    <div class="relative w-32 h-32">
                        <svg class="w-32 h-32 progress-ring transform -rotate-90" viewBox="0 0 120 120">
                            <circle cx="60" cy="60" r="50" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                            <circle cx="60" cy="60" r="50" stroke-width="8" fill="none" 
                                    stroke-dasharray="314" stroke-dashoffset="78.5" stroke-linecap="round" id="healthScoreCircle"/>
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <span class="text-2xl font-bold text-green-600" id="healthScoreValue">75</span>
                            <span class="text-xs text-gray-500" id="healthScoreLabel">å¥åº·ç¨³å¥</span>
                        </div>
                    </div>
                </div>
                <div class="text-center">
                    <p class="text-sm text-gray-600 mb-2" id="healthScoreDescription">æ‚¨çš„è´¢åŠ¡çŠ¶å†µè‰¯å¥½ï¼Œç»§ç»­ä¿æŒï¼</p>
                    <div class="grid grid-cols-3 gap-2 text-xs text-gray-500">
                        <div class="text-center">
                            <div class="w-3 h-3 bg-red-500 rounded-full mx-auto mb-1"></div>
                            <span>éœ€æ”¹å–„</span>
                        </div>
                        <div class="text-center">
                            <div class="w-3 h-3 bg-yellow-500 rounded-full mx-auto mb-1"></div>
                            <span>è‰¯å¥½</span>
                        </div>
                        <div class="text-center">
                            <div class="w-3 h-3 bg-green-500 rounded-full mx-auto mb-1"></div>
                            <span>ä¼˜ç§€</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="mb-6">
            <div class="bg-white rounded-2xl p-4 card-shadow">
                <h3 class="font-semibold text-gray-800 mb-4">å…³é”®æŒ‡æ ‡</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-center p-3 bg-green-50 rounded-xl">
                        <p class="text-xs text-gray-600 mb-1">å‚¨è“„ç‡</p>
                        <p class="text-lg font-bold text-green-600" id="savingsRate">0%</p>
                    </div>
                    <div class="text-center p-3 bg-blue-50 rounded-xl">
                        <p class="text-xs text-gray-600 mb-1">æ”¯å‡ºæ¯”ä¾‹</p>
                        <p class="text-lg font-bold text-blue-600" id="expenseRatio">0%</p>
                    </div>
                    <div class="text-center p-3 bg-purple-50 rounded-xl">
                        <p class="text-xs text-gray-600 mb-1">æœˆåº¦ç»“ä½™</p>
                        <p class="text-lg font-bold text-purple-600" id="monthlyBalance">Â¥0</p>
                    </div>
                    <div class="text-center p-3 bg-orange-50 rounded-xl">
                        <p class="text-xs text-gray-600 mb-1">è´¦å•æ•°é‡</p>
                        <p class="text-lg font-bold text-orange-600" id="billCount">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Analysis -->
        <div class="mb-6">
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl p-4 card-shadow border border-purple-200">
                <div class="flex items-center mb-3">
                    <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center mr-3">
                        <span class="text-white text-sm">ğŸ¤–</span>
                    </div>
                    <h3 class="font-semibold text-gray-800">AIè´¢åŠ¡åˆ†æ</h3>
                </div>
                <div id="aiAnalysisContent" class="text-sm text-gray-600">
                    <div class="flex items-center justify-center py-4">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-purple-500"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trends Tab -->
    <div id="trendsTab" class="tab-content px-4 hidden">
        <!-- Period Selector -->
        <div class="mb-4">
            <div class="flex space-x-2 bg-gray-100 rounded-xl p-1">
                <button onclick="changePeriod('month')" class="period-tab flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all tab-active" data-period="month">
                    æœ¬æœˆ
                </button>
                <button onclick="changePeriod('year')" class="period-tab flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all text-gray-600" data-period="year">
                    æœ¬å¹´
                </button>
            </div>
        </div>

        <!-- Income/Expense Trend Chart -->
        <div class="mb-6">
            <div class="bg-white rounded-2xl p-4 card-shadow">
                <h3 class="font-semibold text-gray-800 mb-4">æ”¶æ”¯è¶‹åŠ¿</h3>
                <div id="trendChart" class="chart-container"></div>
            </div>
        </div>

        <!-- Monthly Summary -->
        <div class="mb-6">
            <div class="bg-white rounded-2xl p-4 card-shadow">
                <h3 class="font-semibold text-gray-800 mb-4">æœˆåº¦ç»Ÿè®¡</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-center p-3 bg-green-50 rounded-xl">
                        <p class="text-xs text-gray-600 mb-1">æ€»æ”¶å…¥</p>
                        <p class="text-lg font-bold text-green-600" id="trendTotalIncome">Â¥0</p>
                    </div>
                    <div class="text-center p-3 bg-red-50 rounded-xl">
                        <p class="text-xs text-gray-600 mb-1">æ€»æ”¯å‡º</p>
                        <p class="text-lg font-bold text-red-600" id="trendTotalExpense">Â¥0</p>
                    </div>
                </div>
                <div class="mt-4 text-center p-3 bg-blue-50 rounded-xl">
                    <p class="text-xs text-gray-600 mb-1">æ€»ç»“ä½™</p>
                    <p class="text-lg font-bold text-blue-600" id="trendTotalBalance">Â¥0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Expenses Tab -->
    <div id="expensesTab" class="tab-content px-4 hidden">
        <!-- Expense Pie Chart -->
        <div class="mb-6">
            <div class="bg-white rounded-2xl p-4 card-shadow">
                <h3 class="font-semibold text-gray-800 mb-4">æ”¯å‡ºåˆ†ç±»</h3>
                <div id="expenseChart" class="chart-container"></div>
            </div>
        </div>

        <!-- Top Expenses -->
        <div class="mb-6">
            <div class="bg-white rounded-2xl p-4 card-shadow">
                <h3 class="font-semibold text-gray-800 mb-4">ä¸»è¦æ”¯å‡º</h3>
                <div id="topExpenses">
                    <div class="flex items-center justify-center py-4">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Expense Insights -->
        <div class="mb-6">
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-4 card-shadow border border-blue-200">
                <div class="flex items-center mb-3">
                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center mr-3">
                        <span class="text-white text-sm">ğŸ’¡</span>
                    </div>
                    <h3 class="font-semibold text-gray-800">æ”¯å‡ºæ´å¯Ÿ</h3>
                </div>
                <div id="expenseInsights" class="text-sm text-gray-600">
                    æ­£åœ¨åˆ†ææ‚¨çš„æ”¯å‡ºæ¨¡å¼...
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-40">
        <div class="grid grid-cols-5 h-16">
            <a href="index.html" class="flex flex-col items-center justify-center text-gray-400">
                <span class="text-lg mb-1">ğŸ </span>
                <span class="text-xs">é¦–é¡µ</span>
            </a>
            <a href="bills.html" class="flex flex-col items-center justify-center text-gray-400">
                <span class="text-lg mb-1">ğŸ“</span>
                <span class="text-xs">è´¦å•</span>
            </a>
            <a href="analysis.html" class="flex flex-col items-center justify-center text-green-600">
                <span class="text-lg mb-1">ğŸ“Š</span>
                <span class="text-xs">åˆ†æ</span>
            </a>
            <a href="savings.html" class="flex flex-col items-center justify-center text-gray-400">
                <span class="text-lg mb-1">ğŸ¯</span>
                <span class="text-xs">å‚¨è“„</span>
            </a>
            <a href="insurance.html" class="flex flex-col items-center justify-center text-gray-400">
                <span class="text-lg mb-1">ğŸ›¡ï¸</span>
                <span class="text-xs">ä¿éšœ</span>
            </a>
        </div>
    </nav>

    <script src="main.js"></script>
    <script>
        // åˆ†æé¡µé¢ç‰¹å®šçš„JavaScript
        let currentTab = 'overview';
        let currentPeriod = 'month';
        let trendChart = null;
        let expenseChart = null;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadOverviewData();
            loadTrendData();
            loadExpenseData();
        });

        // åˆ‡æ¢æ ‡ç­¾
        function switchTab(tab) {
            currentTab = tab;
            
            // æ›´æ–°æ ‡ç­¾æ ·å¼
            document.querySelectorAll('.analysis-tab').forEach(t => {
                t.classList.remove('tab-active');
                t.classList.add('text-gray-600');
            });
            document.querySelector(`[data-tab="${tab}"]`).classList.add('tab-active');
            document.querySelector(`[data-tab="${tab}"]`).classList.remove('text-gray-600');
            
            // æ˜¾ç¤ºå¯¹åº”å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(tab + 'Tab').classList.remove('hidden');
            
            // é‡æ–°æ¸²æŸ“å›¾è¡¨
            if (tab === 'trends' && trendChart) {
                setTimeout(() => trendChart.resize(), 100);
            } else if (tab === 'expenses' && expenseChart) {
                setTimeout(() => expenseChart.resize(), 100);
            }
        }

        // åˆ‡æ¢æ—¶é—´å‘¨æœŸ
        function changePeriod(period) {
            currentPeriod = period;
            
            // æ›´æ–°æ ‡ç­¾æ ·å¼
            document.querySelectorAll('.period-tab').forEach(t => {
                t.classList.remove('tab-active');
                t.classList.add('text-gray-600');
            });
            document.querySelector(`[data-period="${period}"]`).classList.add('tab-active');
            document.querySelector(`[data-period="${period}"]`).classList.remove('text-gray-600');
            
            loadTrendData();
        }

        // åŠ è½½æ€»è§ˆæ•°æ®
        async function loadOverviewData() {
            try {
                const dashboardData = await financeManager.getDashboardSummary();
                const healthScore = dashboardData.healthScore ?? 75;

                let label, description, colorClass,colorHex;
                if (healthScore >= 80) {
                    label = 'ä¼˜ç§€';
                    description = 'æ‚¨çš„è´¢åŠ¡çŠ¶å†µéå¸¸å¥åº·ï¼';
                    colorClass = 'text-green-600';
                    colorHex = '#10B981';
                } else if (healthScore >= 60) {
                    label = 'è‰¯å¥½';
                    description = 'æ‚¨çš„è´¢åŠ¡çŠ¶å†µè‰¯å¥½ï¼Œç»§ç»­ä¿æŒï¼';
                    colorClass = 'text-blue-600';
                    colorHex = '#2563EB';
                } else {
                    label = 'éœ€æ”¹å–„';
                    description = 'å»ºè®®ä¼˜åŒ–æ‚¨çš„è´¢åŠ¡ç®¡ç†ã€‚';
                    colorClass = 'text-red-600';
                    colorHex = '#DC2626';
                }

                // æ›´æ–°è´¢åŠ¡å¥åº·åº¦
                document.getElementById('healthScoreValue').className = `text-2xl font-bold ${colorClass}`;
                financeManager.animateScore('healthScoreValue', healthScore);
                
                // æ›´æ–°å¥åº·åº¦æ ‡ç­¾
                document.getElementById('healthScoreLabel').textContent = label;
                document.getElementById('healthScoreLabel').className = `text-xs ${colorClass}`;
                document.getElementById('healthScoreDescription').textContent = description;

                // æ›´æ–°åœ†å½¢è¿›åº¦æ¡
                const circle = document.getElementById('healthScoreCircle');
                const circumference = 2 * Math.PI * 50;
                const offset = circumference - (healthScore / 100) * circumference;
                circle.style.strokeDashoffset = offset;
                circle.setAttribute('stroke',colorHex)
                circle.style.strokeDashoffset = circumference;
                anime({
                    targets: circle,
                    // åŠ¨ç”»ç›®æ ‡å€¼ï¼šä»æ»¡åœ†(circumference)åˆ°æœ€ç»ˆè¿›åº¦(finalOffset)
                    strokeDashoffset: offset, 
                    // åŠ¨ç”»æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
                    duration: 750, 
                    // åŠ¨ç”»ç¼“åŠ¨å‡½æ•°
                    easing: 'easeInOutQuad', 
                    // åŠ¨ç”»å¼€å§‹å»¶è¿Ÿï¼ˆå¯é€‰ï¼Œè®©ç”¨æˆ·å…ˆçœ‹åˆ°åˆ†æ•°å˜åŒ–ï¼‰
                    delay: 100, 
                });
                // æ›´æ–°å…³é”®æŒ‡æ ‡
                const savingsRate = dashboardData.totalIncome > 0 ? 
                    ((dashboardData.balance / dashboardData.totalIncome) * 100).toFixed(1) : 0;
                const expenseRatio = dashboardData.totalIncome > 0 ? 
                    ((dashboardData.totalExpense / dashboardData.totalIncome) * 100).toFixed(1) : 0;
                
                document.getElementById('savingsRate').textContent = savingsRate + '%';
                document.getElementById('expenseRatio').textContent = expenseRatio + '%';
                financeManager.animateNumber('monthlyBalance', dashboardData.balance);
                
                // è·å–è´¦å•æ•°é‡
                const bills = await financeManager.getBills();
                document.getElementById('billCount').textContent = bills.length;
                
            } catch (error) {
                console.error('Failed to load overview data:', error);
            }
        }

        // åŠ è½½è¶‹åŠ¿æ•°æ®
        async function loadTrendData() {
            try {
                const trendData = await financeManager.getAnalysisTrends(currentPeriod);
                
                // æ›´æ–°è¶‹åŠ¿ç»Ÿè®¡
                const totalIncome = trendData.incomeData.reduce((sum, val) => sum + val, 0);
                const totalExpense = trendData.expenseData.reduce((sum, val) => sum + val, 0);
                const totalBalance = totalIncome - totalExpense;
                
                document.getElementById('trendTotalIncome').textContent = 'Â¥' + totalIncome.toFixed(2);
                document.getElementById('trendTotalExpense').textContent = 'Â¥' + totalExpense.toFixed(2);
                document.getElementById('trendTotalBalance').textContent = 'Â¥' + totalBalance.toFixed(2);
                
                // æ¸²æŸ“è¶‹åŠ¿å›¾è¡¨
                renderTrendChart(trendData);
                
            } catch (error) {
                console.error('Failed to load trend data:', error);
            }
        }

        // æ¸²æŸ“è¶‹åŠ¿å›¾è¡¨
        function renderTrendChart(data) {
            const chartDom = document.getElementById('trendChart');
            if (trendChart) {
                trendChart.dispose();
            }
            trendChart = echarts.init(chartDom);
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    }
                },
                legend: {
                    data: ['æ”¶å…¥', 'æ”¯å‡º'],
                    bottom: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: data.dates,
                    axisLine: {
                        lineStyle: {
                            color: '#e5e7eb'
                        }
                    },
                    axisLabel: {
                        color: '#6b7280',
                        fontSize: 12
                    }
                },
                yAxis: {
                    type: 'value',
                    axisLine: {
                        lineStyle: {
                            color: '#e5e7eb'
                        }
                    },
                    axisLabel: {
                        color: '#6b7280',
                        fontSize: 12,
                        formatter: 'Â¥{value}'
                    },
                    splitLine: {
                        lineStyle: {
                            color: '#f3f4f6'
                        }
                    }
                },
                series: [
                    {
                        name: 'æ”¶å…¥',
                        type: 'line',
                        data: data.incomeData,
                        smooth: true,
                        lineStyle: {
                            color: '#10b981',
                            width: 3
                        },
                        itemStyle: {
                            color: '#10b981'
                        },
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [{
                                    offset: 0, color: 'rgba(16, 185, 129, 0.3)'
                                }, {
                                    offset: 1, color: 'rgba(16, 185, 129, 0.05)'
                                }]
                            }
                        }
                    },
                    {
                        name: 'æ”¯å‡º',
                        type: 'line',
                        data: data.expenseData,
                        smooth: true,
                        lineStyle: {
                            color: '#ef4444',
                            width: 3
                        },
                        itemStyle: {
                            color: '#ef4444'
                        },
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [{
                                    offset: 0, color: 'rgba(239, 68, 68, 0.3)'
                                }, {
                                    offset: 1, color: 'rgba(239, 68, 68, 0.05)'
                                }]
                            }
                        }
                    }
                ]
            };
            
            trendChart.setOption(option);
        }

        // åŠ è½½æ”¯å‡ºæ•°æ®
        async function loadExpenseData() {
            try {
                const expenseData = await financeManager.getAnalysisExpensePie();
                
                // æ¸²æŸ“æ”¯å‡ºé¥¼å›¾
                renderExpenseChart(expenseData);
                
                // æ˜¾ç¤ºä¸»è¦æ”¯å‡º
                showTopExpenses(expenseData);
                
                // æ˜¾ç¤ºæ”¯å‡ºæ´å¯Ÿ
                generateExpenseInsights(expenseData);
                
            } catch (error) {
                console.error('Failed to load expense data:', error);
            }
        }

        // æ¸²æŸ“æ”¯å‡ºé¥¼å›¾
        function renderExpenseChart(data) {
            const chartDom = document.getElementById('expenseChart');
            if (expenseChart) {
                expenseChart.dispose();
            }
            expenseChart = echarts.init(chartDom);
            
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F'];
            
            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{a} <br/>{b}: Â¥{c} ({d}%)'
                },
                legend: {
                    orient: 'horizontal',
                    bottom: 0,
                    textStyle: {
                        fontSize: 12,
                        color: '#6b7280'
                    }
                },
                series: [
                    {
                        name: 'æ”¯å‡º',
                        type: 'pie',
                        radius: ['40%', '70%'],
                        center: ['50%', '45%'],
                        avoidLabelOverlap: false,
                        itemStyle: {
                            borderRadius: 8,
                            borderColor: '#fff',
                            borderWidth: 2
                        },
                        label: {
                            show: false,
                            position: 'center'
                        },
                        emphasis: {
                            label: {
                                show: true,
                                fontSize: '16',
                                fontWeight: 'bold'
                            }
                        },
                        labelLine: {
                            show: false
                        },
                        data: data.map((item, index) => ({
                            value: item.value,
                            name: item.name,
                            itemStyle: {
                                color: colors[index % colors.length]
                            }
                        }))
                    }
                ]
            };
            
            expenseChart.setOption(option);
        }

        // æ˜¾ç¤ºä¸»è¦æ”¯å‡º
        function showTopExpenses(data) {
            const container = document.getElementById('topExpenses');
            
            if (data.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-gray-500">
                        <p class="text-sm">æš‚æ— æ”¯å‡ºæ•°æ®</p>
                    </div>
                `;
                return;
            }
            
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F'];
            const totalExpense = data.reduce((sum, item) => sum + item.value, 0);
            
            container.innerHTML = data.slice(0, 5).map((item, index) => `
                <div class="flex items-center justify-between py-3 border-b border-gray-100 last:border-b-0">
                    <div class="flex items-center space-x-3">
                        <div class="w-4 h-4 rounded-full" style="background-color: ${colors[index % colors.length]}"></div>
                        <span class="text-sm text-gray-700">${item.name}</span>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-medium text-gray-800">Â¥${item.value.toFixed(2)}</p>
                        <p class="text-xs text-gray-500">${((item.value / totalExpense) * 100).toFixed(1)}%</p>
                    </div>
                </div>
            `).join('');
        }

        // ç”Ÿæˆæ”¯å‡ºæ´å¯Ÿ
        function generateExpenseInsights(data) {
            const container = document.getElementById('expenseInsights');
            
            if (data.length === 0) {
                container.innerHTML = 'æš‚æ— æ”¯å‡ºæ•°æ®å¯ä¾›åˆ†æã€‚';
                return;
            }
            
            const totalExpense = data.reduce((sum, item) => sum + item.value, 0);
            const maxExpense = Math.max(...data.map(item => item.value));
            const maxCategory = data.find(item => item.value === maxExpense);
            
            let insights = [];
            
            // ä¸»è¦æ”¯å‡ºç±»åˆ«åˆ†æ
            if (maxCategory && (maxExpense / totalExpense) > 0.3) {
                insights.push(`${maxCategory.name}æ˜¯æ‚¨çš„ä¸»è¦æ”¯å‡ºç±»åˆ«ï¼Œå æ€»æ”¯å‡ºçš„${((maxExpense / totalExpense) * 100).toFixed(1)}%ã€‚`);
            }
            
            // æ”¯å‡ºå»ºè®®
            if ((maxExpense / totalExpense) > 0.5) {
                insights.push('å»ºè®®åˆ†æ•£æ”¯å‡ºï¼Œé¿å…å•ä¸€ç±»åˆ«æ”¯å‡ºè¿‡é«˜ã€‚');
            } else if (data.length > 5) {
                insights.push('æ‚¨çš„æ”¯å‡ºåˆ†å¸ƒè¾ƒä¸ºå‡è¡¡ï¼Œè¿™æ˜¯è‰¯å¥½çš„è´¢åŠ¡ç®¡ç†è¡¨ç°ã€‚');
            }
            
            // å‚¨è“„å»ºè®®
            const savingsRate = 100 - ((maxExpense / totalExpense) * 100);
            if (savingsRate > 20) {
                insights.push('æ‚¨æœ‰å¾ˆå¥½çš„å‚¨è“„ä¹ æƒ¯ï¼Œå»ºè®®ç»§ç»­ä¿æŒã€‚');
            } else if (savingsRate > 10) {
                insights.push('å¯ä»¥è€ƒè™‘é€‚å½“å¢åŠ å‚¨è“„æ¯”ä¾‹ï¼Œä¸ºæœªæ¥åšå¥½å‡†å¤‡ã€‚');
            }
            
            container.innerHTML = insights.join(' ') || 'æ‚¨çš„æ”¯å‡ºæ¨¡å¼æ­£å¸¸ï¼Œç»§ç»­ä¿æŒè‰¯å¥½çš„è´¢åŠ¡ä¹ æƒ¯ã€‚';
        }

        // åŠ è½½AIåˆ†æ
        // ä¿®æ”¹åçš„ AI åˆ†æå‡½æ•°
        async function loadAIAnalysis() {
            const container = document.getElementById('aiAnalysisContent');
            const refreshBtn = document.querySelector('#aiAnalysisSection .refresh-btn');
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                container.innerHTML = `
                    <div class="ai-loading">
                        <div class="loading-spinner"></div>
                        <span>AIæ­£åœ¨åˆ†ææ‚¨çš„è´¢åŠ¡çŠ¶å†µï¼Œè¯·ç¨å€™...</span>
                    </div>
                `;
                
                // ç¦ç”¨åˆ·æ–°æŒ‰é’®
                if (refreshBtn) {
                    refreshBtn.disabled = true;
                }
                
                let analysisText = '';
                let isFirstChunk = true;
                
                await financeManager.getFinancialAdviceStream((chunk) => {
                    if (isFirstChunk) {
                        // ç¬¬ä¸€ä¸ª chunk æ¸…é™¤åŠ è½½çŠ¶æ€
                        container.innerHTML = '';
                        isFirstChunk = false;
                    }
                    
                    analysisText += chunk;
                    
                    // ä½¿ç”¨ markdown æ ¼å¼æ¸²æŸ“
                    const formattedText = formatAIText(analysisText);
                    container.innerHTML = formattedText;
                    
                    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                    container.scrollTop = container.scrollHeight;
                });
                
                // å®Œæˆåæ·»åŠ å®Œæˆæ ‡è¯†
                container.innerHTML += `
                    <div class="ai-complete">
                        <hr>
                        <p class="text-muted" style="font-size: 0.9em; margin-top: 1rem;">
                            <i class="fas fa-check-circle"></i> AIåˆ†æå®Œæˆ
                        </p>
                    </div>
                `;
                
            } catch (error) {
                console.error('AIåˆ†æé”™è¯¯:', error);
                container.innerHTML = `
                    <div class="ai-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>AIåˆ†æåŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•ã€‚</p>
                        <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadAIAnalysis()">
                            é‡æ–°å°è¯•
                        </button>
                    </div>
                `;
            } finally {
                // é‡æ–°å¯ç”¨åˆ·æ–°æŒ‰é’®
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                }
            }
        }

        // æ ¼å¼åŒ– AI æ–‡æœ¬ï¼ˆæ”¯æŒ markdown æ ·å¼ï¼‰
        function formatAIText(text) {
            // å¤„ç†æ ‡é¢˜
            text = text.replace(/^# (.*$)/gim, '<h4 class="ai-heading">$1</h4>');
            text = text.replace(/^## (.*$)/gim, '<h5 class="ai-subheading">$1</h5>');
            text = text.replace(/^### (.*$)/gim, '<h6 class="ai-subheading">$1</h6>');
            
            // å¤„ç†åˆ—è¡¨
            text = text.replace(/^\d+\.\s+(.*$)/gim, '<li class="ai-list-item">$1</li>');
            text = text.replace(/^-\s+(.*$)/gim, '<li class="ai-list-item">$1</li>');
            
            // åŒ…è£…åˆ—è¡¨
            text = text.replace(/(<li class="ai-list-item">.*<\/li>)/g, '<ul class="ai-list">$1</ul>');
            
            // å¤„ç†æ®µè½
            const paragraphs = text.split('\n\n');
            let formattedText = '';
            
            paragraphs.forEach(paragraph => {
                if (paragraph.trim()) {
                    if (!paragraph.startsWith('<') && !paragraph.endsWith('>')) {
                        formattedText += `<p class="ai-paragraph">${paragraph}</p>`;
                    } else {
                        formattedText += paragraph;
                    }
                }
            });
            
            return formattedText;
        }

        // åˆ·æ–°åˆ†ææ•°æ®
        function refreshAnalysis() {
            showToast('æ­£åœ¨åˆ·æ–°æ•°æ®...', 'info');
            
            loadOverviewData();
            loadTrendData();
            loadExpenseData();
            loadAIAnalysis();
        }

        // é¡µé¢åŠ è½½å®ŒæˆååŠ è½½AIåˆ†æ
        document.addEventListener('DOMContentLoaded', function() {
            // å»¶è¿ŸåŠ è½½ AI åˆ†æï¼Œè®©å…¶ä»–é‡è¦æ•°æ®å…ˆåŠ è½½
            setTimeout(() => {
                loadAIAnalysis();
            }, 1500);
        });

        // å“åº”å¼å›¾è¡¨
        window.addEventListener('resize', function() {
            if (trendChart) {
                trendChart.resize();
            }
            if (expenseChart) {
                expenseChart.resize();
            }
        });
    </script>
</body>
</html>