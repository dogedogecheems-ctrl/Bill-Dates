<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‚¨è“„ç›®æ ‡ - è´¢åŠ¡ä¿éšœ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #f8faf9 0%, #e8f5e8 100%);
        }
        .card-shadow {
            box-shadow: 0 4px 20px rgba(45, 90, 39, 0.1);
        }
        .floating-btn {
            box-shadow: 0 8px 25px rgba(45, 90, 39, 0.3);
        }
        .goal-item {
            transition: all 0.3s ease;
        }
        .goal-item:active {
            transform: scale(0.98);
        }
        .toast-notification {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .touch-feedback {
            transition: transform 0.1s ease;
        }
        .touch-feedback:active {
            transform: scale(0.98);
        }
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
        .progress-ring {
            transform: rotate(-90deg);
        }
        .progress-ring-circle {
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
    </style>
</head>
<body class="min-h-screen pb-20">
    <!-- Header -->
    <div class="bg-white shadow-sm px-4 py-4">
        <div class="flex items-center justify-between">
            <h1 class="text-xl font-bold text-gray-800">å‚¨è“„ç›®æ ‡</h1>
            <div class="flex items-center space-x-2">
                <button onclick="showStatsModal()" class="p-2 text-gray-600 touch-feedback">
                    <span class="text-lg">ğŸ“Š</span>
                </button>
                <button onclick="showAddGoalModal()" class="p-2 text-gray-600 touch-feedback">
                    <span class="text-lg">â•</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Savings Stats -->
    <div class="px-4 py-4">
        <div class="bg-white rounded-2xl p-4 card-shadow">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="text-center">
                    <p class="text-xs text-gray-500 mb-1">æ€»å‚¨è“„</p>
                    <p class="text-xl font-bold text-green-600" id="totalSavings">Â¥0</p>
                </div>
                <div class="text-center">
                    <p class="text-xs text-gray-500 mb-1">æœ¬æœˆå‚¨è“„</p>
                    <p class="text-xl font-bold text-blue-600" id="monthlySavings">Â¥0</p>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="text-center">
                    <p class="text-xs text-gray-500 mb-1">è¿›è¡Œä¸­</p>
                    <p class="text-lg font-semibold text-orange-600" id="activeGoals">0</p>
                </div>
                <div class="text-center">
                    <p class="text-xs text-gray-500 mb-1">å·²å®Œæˆ</p>
                    <p class="text-lg font-semibold text-green-600" id="completedGoals">0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Goals List -->
    <div class="px-4">
        <div id="goalsList" class="space-y-4">
            <div class="flex items-center justify-center py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
            </div>
        </div>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="hidden px-4 py-12">
        <div class="text-center">
            <div class="text-6xl mb-4">ğŸ¯</div>
            <h3 class="text-lg font-semibold text-gray-800 mb-2">è¿˜æ²¡æœ‰å‚¨è“„ç›®æ ‡</h3>
            <p class="text-sm text-gray-500 mb-6">åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªå‚¨è“„ç›®æ ‡</p>
            <button onclick="showAddGoalModal()" class="bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-xl font-medium touch-feedback">
                åˆ›å»ºç›®æ ‡
            </button>
        </div>
    </div>

    <!-- Floating Add Button -->
    <button onclick="showAddGoalModal()" class="fixed bottom-20 right-4 w-14 h-14 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-full flex items-center justify-center text-2xl floating-btn z-30 touch-feedback">
        +
    </button>

    <!-- Add/Edit Goal Modal -->
    <div id="addGoalModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-end justify-center min-h-screen">
            <div class="bg-white rounded-t-3xl w-full max-w-md p-6 transform transition-transform duration-300 translate-y-full modal-content" id="goalModalContent">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold" id="goalModalTitle">åˆ›å»ºå‚¨è“„ç›®æ ‡</h3>
                    <button onclick="hideAddGoalModal()" class="text-gray-400 text-xl touch-feedback">Ã—</button>
                </div>
                
                <form id="goalForm" class="space-y-4">
                    <input type="hidden" id="goalId">
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ç›®æ ‡åç§°</label>
                        <input type="text" id="goalName" placeholder="ä¾‹å¦‚ï¼šä¹°è½¦åŸºé‡‘" 
                               class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ç›®æ ‡ç±»å‹</label>
                        <select id="goalType" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <option value="emergency">åº”æ€¥åŸºé‡‘</option>
                            <option value="vacation">æ—…æ¸¸åŸºé‡‘</option>
                            <option value="house">è´­æˆ¿åŸºé‡‘</option>
                            <option value="car">è´­è½¦åŸºé‡‘</option>
                            <option value="education">æ•™è‚²åŸºé‡‘</option>
                            <option value="retirement">é€€ä¼‘åŸºé‡‘</option>
                            <option value="investment">æŠ•èµ„æœ¬é‡‘</option>
                            <option value="other">å…¶ä»–ç›®æ ‡</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ç›®æ ‡é‡‘é¢</label>
                        <input type="number" id="goalTargetAmount" placeholder="0.00" step="0.01" 
                               class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å½“å‰é‡‘é¢</label>
                        <input type="number" id="goalCurrentAmount" placeholder="0.00" step="0.01" value="0" 
                               class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ç›®æ ‡æ—¥æœŸï¼ˆå¯é€‰ï¼‰</label>
                        <input type="date" id="goalTargetDate" 
                               class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                    
                    <button type="submit" id="submitGoalBtn" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white p-3 rounded-xl font-medium touch-feedback">
                        åˆ›å»ºç›®æ ‡
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Goal Detail Modal -->
    <div id="goalDetailModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-end justify-center min-h-screen">
            <div class="bg-white rounded-t-3xl w-full max-w-md p-6 transform transition-transform duration-300 translate-y-full modal-content" id="detailModalContent">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">ç›®æ ‡è¯¦æƒ…</h3>
                    <button onclick="hideGoalDetailModal()" class="text-gray-400 text-xl touch-feedback">Ã—</button>
                </div>
                
                <div id="goalDetailContent">
                    <!-- Goal details will be loaded here -->
                </div>
                
                <div class="space-y-3 mt-6">
                    <button onclick="addSavingsToGoal()" class="w-full bg-green-500 text-white p-3 rounded-xl font-medium touch-feedback">
                        æ·»åŠ å‚¨è“„
                    </button>
                    <div class="flex space-x-3">
                        <button onclick="editGoal()" class="flex-1 bg-blue-500 text-white p-3 rounded-xl font-medium touch-feedback">
                            ç¼–è¾‘
                        </button>
                        <button onclick="deleteGoal()" class="flex-1 bg-red-500 text-white p-3 rounded-xl font-medium touch-feedback">
                            åˆ é™¤
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Savings Modal -->
    <div id="addSavingsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-end justify-center min-h-screen">
            <div class="bg-white rounded-t-3xl w-full max-w-md p-6 transform transition-transform duration-300 translate-y-full modal-content" id="savingsModalContent">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">æ·»åŠ å‚¨è“„</h3>
                    <button onclick="hideAddSavingsModal()" class="text-gray-400 text-xl touch-feedback">Ã—</button>
                </div>
                
                <form id="savingsForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ·»åŠ é‡‘é¢</label>
                        <input type="number" id="savingsAmount" placeholder="0.00" step="0.01" 
                               class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                    
                    <button type="submit" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white p-3 rounded-xl font-medium touch-feedback">
                        ç¡®è®¤æ·»åŠ 
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Stats Modal -->
    <div id="statsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-end justify-center min-h-screen">
            <div class="bg-white rounded-t-3xl w-full max-w-md p-6 transform transition-transform duration-300 translate-y-full modal-content" id="statsModalContent">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">å‚¨è“„ç»Ÿè®¡</h3>
                    <button onclick="hideStatsModal()" class="text-gray-400 text-xl touch-feedback">Ã—</button>
                </div>
                
                <div id="statsContent">
                    <!-- Stats will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-40">
        <div class="grid grid-cols-5 h-16">
            <a href="index.html" class="flex flex-col items-center justify-center text-gray-400">
                <span class="text-lg mb-1">ğŸ </span>
                <span class="text-xs">é¦–é¡µ</span>
            </a>
            <a href="bills.html" class="flex flex-col items-center justify-center text-gray-400">
                <span class="text-lg mb-1">ğŸ“</span>
                <span class="text-xs">è´¦å•</span>
            </a>
            <a href="analysis.html" class="flex flex-col items-center justify-center text-gray-400">
                <span class="text-lg mb-1">ğŸ“Š</span>
                <span class="text-xs">åˆ†æ</span>
            </a>
            <a href="savings.html" class="flex flex-col items-center justify-center text-green-600">
                <span class="text-lg mb-1">ğŸ¯</span>
                <span class="text-xs">å‚¨è“„</span>
            </a>
            <a href="insurance.html" class="flex flex-col items-center justify-center text-gray-400">
                <span class="text-lg mb-1">ğŸ“ˆ</span>
                <span class="text-xs">æŠ•èµ„</span>
            </a>
        </div>
    </nav>

    <script src="main.js"></script>
    <script>
        // å‚¨è“„é¡µé¢ç‰¹å®šçš„JavaScript
        let selectedGoalId = null;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadSavingsStats();
            loadSavingsGoals();
        });

        // åŠ è½½å‚¨è“„ç»Ÿè®¡
        async function loadSavingsStats() {
            try {
                const stats = await financeManager.getSavingsStats();
                
                financeManager.animateNumber('totalSavings', stats.totalSavings);
                financeManager.animateNumber('monthlySavings', stats.monthlySavings);
                document.getElementById('activeGoals').textContent = stats.activeGoals;
                document.getElementById('completedGoals').textContent = stats.completedGoals;
            } catch (error) {
                console.error('Failed to load savings stats:', error);
            }
        }

        // åŠ è½½å‚¨è“„ç›®æ ‡
        async function loadSavingsGoals() {
            const goalsList = document.getElementById('goalsList');
            const emptyState = document.getElementById('emptyState');
            
            goalsList.innerHTML = `
                <div class="flex items-center justify-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                </div>
            `;
            
            try {
                const goals = await financeManager.getSavingsGoals();
                
                if (goals.length === 0) {
                    goalsList.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    return;
                }
                
                emptyState.classList.add('hidden');
                
                goalsList.innerHTML = goals.map(goal => `
                    <div class="goal-item bg-white rounded-2xl p-4 card-shadow" onclick="showGoalDetail(${goal.id})">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-gray-800">${goal.name}</h3>
                            <span class="text-xs px-2 py-1 rounded-full ${
                                goal.type === 'emergency' ? 'bg-red-100 text-red-600' :
                                goal.type === 'vacation' ? 'bg-blue-100 text-blue-600' :
                                goal.type === 'house' ? 'bg-green-100 text-green-600' :
                                goal.type === 'car' ? 'bg-purple-100 text-purple-600' :
                                goal.type === 'education' ? 'bg-yellow-100 text-yellow-600' :
                                goal.type === 'retirement' ? 'bg-indigo-100 text-indigo-600' :
                                'bg-gray-100 text-gray-600'
                            }">
                                ${getSavingsGoalTypeName(goal.type)}
                            </span>
                        </div>
                        
                        <div class="mb-3">
                            <div class="flex justify-between text-sm text-gray-600 mb-2">
                                <span>Â¥${goal.currentAmount.toFixed(2)}</span>
                                <span>Â¥${goal.targetAmount.toFixed(2)}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="bg-gradient-to-r from-green-400 to-green-600 h-3 rounded-full transition-all duration-500" 
                                     style="width: ${Math.min(goal.progress, 100)}%"></div>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div class="text-sm text-gray-600">
                                <span class="font-medium">${goal.progress.toFixed(1)}%</span> å·²å®Œæˆ
                                ${goal.targetDate ? `<span class="ml-2">æˆªæ­¢ï¼š${new Date(goal.targetDate).toLocaleDateString()}</span>` : ''}
                            </div>
                            <div class="w-12 h-12 relative">
                                <svg class="w-12 h-12 progress-ring" viewBox="0 0 42 42">
                                    <circle cx="21" cy="21" r="15.915" fill="transparent" stroke="#e5e7eb" stroke-width="3"/>
                                    <circle cx="21" cy="21" r="15.915" fill="transparent" stroke="#10B981" stroke-width="3" 
                                            stroke-dasharray="${goal.progress} ${100 - goal.progress}" stroke-dashoffset="25"/>
                                </svg>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <span class="text-xs font-bold text-green-600">${Math.round(goal.progress)}%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // æ·»åŠ è¿›å…¥åŠ¨ç”»
                anime({
                    targets: '.goal-item',
                    translateY: [20, 0],
                    opacity: [0, 1],
                    delay: anime.stagger(100),
                    duration: 500,
                    easing: 'easeOutQuart'
                });
            } catch (error) {
                console.error('Failed to load savings goals:', error);
                goalsList.innerHTML = `<div class="text-center text-red-500 py-4">åŠ è½½å‚¨è“„ç›®æ ‡å¤±è´¥</div>`;
            }
        }

        // æ˜¾ç¤ºç›®æ ‡è¯¦æƒ…
        function showGoalDetail(goalId) {
            const goal = financeManager.savingsGoals.find(g => g.id === goalId);
            if (!goal) return;
            
            selectedGoalId = goalId;
            
            const modal = document.getElementById('goalDetailModal');
            const content = document.getElementById('detailModalContent');
            const detailContent = document.getElementById('goalDetailContent');
            
            const remaining = Math.max(0, goal.targetAmount - goal.currentAmount);
            const daysLeft = goal.targetDate ? Math.ceil((new Date(goal.targetDate) - new Date()) / (1000 * 60 * 60 * 24)) : null;
            
            detailContent.innerHTML = `
                <div class="space-y-4">
                    <div class="text-center mb-4">
                        <div class="w-20 h-20 mx-auto mb-3 relative">
                            <svg class="w-20 h-20 progress-ring" viewBox="0 0 42 42">
                                <circle cx="21" cy="21" r="15.915" fill="transparent" stroke="#e5e7eb" stroke-width="3"/>
                                <circle cx="21" cy="21" r="15.915" fill="transparent" stroke="#10B981" stroke-width="3" 
                                        stroke-dasharray="${goal.progress} ${100 - goal.progress}" stroke-dashoffset="25"/>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span class="text-lg font-bold text-green-600">${Math.round(goal.progress)}%</span>
                            </div>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-1">${goal.name}</h3>
                        <span class="text-sm px-3 py-1 rounded-full ${
                            goal.type === 'emergency' ? 'bg-red-100 text-red-600' :
                            goal.type === 'vacation' ? 'bg-blue-100 text-blue-600' :
                            goal.type === 'house' ? 'bg-green-100 text-green-600' :
                            goal.type === 'car' ? 'bg-purple-100 text-purple-600' :
                            goal.type === 'education' ? 'bg-yellow-100 text-yellow-600' :
                            goal.type === 'retirement' ? 'bg-indigo-100 text-indigo-600' :
                            'bg-gray-100 text-gray-600'
                        }">
                            ${getSavingsGoalTypeName(goal.type)}
                        </span>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between py-2 border-b border-gray-100">
                            <span class="text-gray-600">å½“å‰é‡‘é¢</span>
                            <span class="font-medium text-green-600">Â¥${goal.currentAmount.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-gray-100">
                            <span class="text-gray-600">ç›®æ ‡é‡‘é¢</span>
                            <span class="font-medium">Â¥${goal.targetAmount.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-gray-100">
                            <span class="text-gray-600">å‰©ä½™é‡‘é¢</span>
                            <span class="font-medium ${remaining > 0 ? 'text-orange-600' : 'text-green-600'}">
                                Â¥${remaining.toFixed(2)}
                            </span>
                        </div>
                        ${goal.targetDate ? `
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">ç›®æ ‡æ—¥æœŸ</span>
                                <span class="font-medium">${new Date(goal.targetDate).toLocaleDateString()}</span>
                            </div>
                            ${daysLeft !== null ? `
                                <div class="flex justify-between py-2 border-b border-gray-100">
                                    <span class="text-gray-600">å‰©ä½™å¤©æ•°</span>
                                    <span class="font-medium ${daysLeft > 0 ? 'text-blue-600' : 'text-red-600'}">
                                        ${daysLeft > 0 ? daysLeft + 'å¤©' : 'å·²è¿‡æœŸ'}
                                    </span>
                                </div>
                            ` : ''}
                        ` : ''}
                        <div class="flex justify-between py-2">
                            <span class="text-gray-600">å®Œæˆè¿›åº¦</span>
                            <span class="font-medium text-blue-600">${goal.progress.toFixed(1)}%</span>
                        </div>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('translate-y-full');
            }, 10);
        }

        // éšè—ç›®æ ‡è¯¦æƒ…æ¨¡æ€æ¡†
        function hideGoalDetailModal() {
            const modal = document.getElementById('goalDetailModal');
            const content = document.getElementById('detailModalContent');
            
            content.classList.add('translate-y-full');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // æ·»åŠ å‚¨è“„åˆ°ç›®æ ‡
        function addSavingsToGoal() {
            hideGoalDetailModal();
            showAddSavingsModal();
        }

        // æ˜¾ç¤ºæ·»åŠ å‚¨è“„æ¨¡æ€æ¡†
        function showAddSavingsModal() {
            const modal = document.getElementById('addSavingsModal');
            const content = document.getElementById('savingsModalContent');
            
            document.getElementById('savingsAmount').value = '';
            modal.classList.remove('hidden');
            setTimeout(() => content.classList.remove('translate-y-full'), 10);
        }

        // éšè—æ·»åŠ å‚¨è“„æ¨¡æ€æ¡†
        function hideAddSavingsModal() {
            const modal = document.getElementById('addSavingsModal');
            const content = document.getElementById('savingsModalContent');
            
            content.classList.add('translate-y-full');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        // ç¼–è¾‘ç›®æ ‡
        function editGoal() {
            const goal = financeManager.savingsGoals.find(g => g.id === selectedGoalId);
            if (!goal) return;
            
            hideGoalDetailModal();
            
            // å¡«å……è¡¨å•
            document.getElementById('goalModalTitle').textContent = 'ç¼–è¾‘å‚¨è“„ç›®æ ‡';
            document.getElementById('submitGoalBtn').textContent = 'æ›´æ–°ç›®æ ‡';
            document.getElementById('goalId').value = goal.id;
            document.getElementById('goalName').value = goal.name;
            document.getElementById('goalType').value = goal.type;
            document.getElementById('goalTargetAmount').value = goal.targetAmount;
            document.getElementById('goalCurrentAmount').value = goal.currentAmount;
            document.getElementById('goalTargetDate').value = goal.targetDate || '';
            
            showAddGoalModal();
        }

        // åˆ é™¤ç›®æ ‡
        async function deleteGoal() {
            if (!selectedGoalId) return;
            
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå‚¨è“„ç›®æ ‡å—ï¼Ÿ')) {
                try {
                    await financeManager.deleteSavingsGoal(selectedGoalId);
                    hideGoalDetailModal();
                    showToast('å‚¨è“„ç›®æ ‡å·²åˆ é™¤', 'success');
                    
                    // åˆ·æ–°æ•°æ®
                    loadSavingsStats();
                    loadSavingsGoals();
                } catch (error) {
                    showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
                }
            }
        }

        // æ¨¡æ€æ¡†æ§åˆ¶
        function showAddGoalModal() {
            const modal = document.getElementById('addGoalModal');
            const content = document.getElementById('goalModalContent');
            modal.classList.remove('hidden');
            setTimeout(() => content.classList.remove('translate-y-full'), 10);
        }

        function hideAddGoalModal() {
            const modal = document.getElementById('addGoalModal');
            const content = document.getElementById('goalModalContent');
            content.classList.add('translate-y-full');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        // æ˜¾ç¤ºç»Ÿè®¡æ¨¡æ€æ¡†
        async function showStatsModal() {
            const modal = document.getElementById('statsModal');
            const content = document.getElementById('statsModalContent');
            const statsContent = document.getElementById('statsContent');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            statsContent.innerHTML = `
                <div class="flex items-center justify-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                    <span class="ml-2 text-gray-600">åŠ è½½ä¸­...</span>
                </div>
            `;
            
            modal.classList.remove('hidden');
            setTimeout(() => content.classList.remove('translate-y-full'), 10);
            
            try {
                // é‡æ–°è·å–ç»Ÿè®¡æ•°æ®
                const stats = await financeManager.getSavingsStats();
                
                // æ›´æ–°ç»Ÿè®¡å†…å®¹
                statsContent.innerHTML = `
                    <div class="space-y-4">
                        <div class="text-center mb-4">
                            <div class="text-4xl mb-2">ğŸ“Š</div>
                            <h3 class="text-lg font-semibold text-gray-800">å‚¨è“„ç»Ÿè®¡</h3>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center p-3 bg-green-50 rounded-xl">
                                <p class="text-xs text-gray-600 mb-1">æ€»å‚¨è“„</p>
                                <p class="text-lg font-bold text-green-600">${financeManager.formatCurrency(stats.totalSavings || 0)}</p>
                            </div>
                            <div class="text-center p-3 bg-blue-50 rounded-xl">
                                <p class="text-xs text-gray-600 mb-1">æœ¬æœˆå‚¨è“„</p>
                                <p class="text-lg font-bold text-blue-600">${financeManager.formatCurrency(stats.monthlySavings || 0)}</p>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">è¿›è¡Œä¸­ç›®æ ‡</span>
                                <span class="font-medium text-orange-600">${stats.activeGoals || 0}</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">å·²å®Œæˆç›®æ ‡</span>
                                <span class="font-medium text-green-600">${stats.completedGoals || 0}</span>
                            </div>
                            <div class="flex justify-between py-2">
                                <span class="text-gray-600">ç›®æ ‡æ€»æ•°</span>
                                <span class="font-medium text-blue-600">${(stats.activeGoals || 0) + (stats.completedGoals || 0)}</span>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Failed to load stats:', error);
                statsContent.innerHTML = `
                    <div class="text-center text-red-500 py-4">
                        åŠ è½½ç»Ÿè®¡å¤±è´¥
                    </div>
                `;
            }
        }

        function hideStatsModal() {
            const modal = document.getElementById('statsModal');
            const content = document.getElementById('statsModalContent');
            content.classList.add('translate-y-full');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        // è¡¨å•æäº¤å¤„ç†
        document.getElementById('goalForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const goalId = document.getElementById('goalId').value;
            const goal = {
                name: document.getElementById('goalName').value,
                type: document.getElementById('goalType').value,
                targetAmount: parseFloat(document.getElementById('goalTargetAmount').value),
                currentAmount: parseFloat(document.getElementById('goalCurrentAmount').value),
                targetDate: document.getElementById('goalTargetDate').value || null
            };

            if (!goal.name || !goal.targetAmount) {
                showToast('ç›®æ ‡åç§°å’Œç›®æ ‡é‡‘é¢ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }

            if (goal.currentAmount > goal.targetAmount) {
                showToast('å½“å‰é‡‘é¢ä¸èƒ½è¶…è¿‡ç›®æ ‡é‡‘é¢', 'error');
                return;
            }

            try {
                if (goalId) {
                    // æ›´æ–°ç›®æ ‡
                    // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦å®ç°æ›´æ–°ç›®æ ‡çš„API
                    showToast('ç›®æ ‡æ›´æ–°åŠŸèƒ½å¼€å‘ä¸­', 'info');
                } else {
                    // åˆ›å»ºç›®æ ‡
                    await financeManager.addSavingsGoal(goal);
                    showToast('å‚¨è“„ç›®æ ‡åˆ›å»ºæˆåŠŸï¼', 'success');
                }
                
                hideAddGoalModal();
                
                // åˆ·æ–°æ•°æ®
                loadSavingsStats();
                loadSavingsGoals();
                
                // é‡ç½®è¡¨å•
                document.getElementById('goalForm').reset();
                
            } catch (error) {
                showToast('æ“ä½œå¤±è´¥: ' + error.message, 'error');
            }
        });

        // æ·»åŠ å‚¨è“„è¡¨å•æäº¤
        document.getElementById('savingsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const amount = parseFloat(document.getElementById('savingsAmount').value);
            
            if (!amount || amount <= 0) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢', 'error');
                return;
            }

            try {
                await financeManager.updateSavingsGoal(selectedGoalId, amount);
                showToast('å‚¨è“„æ·»åŠ æˆåŠŸï¼', 'success');
                hideAddSavingsModal();
                
                // åˆ·æ–°æ•°æ®
                loadSavingsStats();
                loadSavingsGoals();
                
                // é‡ç½®è¡¨å•
                document.getElementById('savingsForm').reset();
                
            } catch (error) {
                showToast('æ“ä½œå¤±è´¥: ' + error.message, 'error');
            }
        });
    </script>
</body>
</html>